<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DoseSense Dashboard</title>
<link rel="icon" type="image/png" href="icons/water.png">

<!-- MOBILE & TABLET SUPPORT -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@font-face {
  font-family: "Debussy";
  src: url("fonts/debussy.ttf") format("truetype");
}

:root {
  --bg:#f6f9fc;
  --card:#ffffff;
  --text:#1c1c1c;
  --muted:#555;
  --badge:#e0e6ef;
}
.dark {
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --badge:#334155;
}

/* MOBILE SAFE */
html, body {
  width:100%;
  max-width:100%;
  overflow-x:hidden;
}

body {
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background:var(--bg);
  color:var(--text);
}
.app {
  max-width:420px;
  margin:auto;
  padding:14px;
}

/* SMALL PHONE ADJUSTMENT */
@media (max-width:420px) {
  .app {
    padding:10px;
  }
}

/* TABLET ADJUSTMENT */
@media (min-width:768px) {
  .app {
    max-width:480px;
  }
}

.card {
  background:var(--card);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}
.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.status {
  display:flex;
  gap:6px;
  font-size:11px;
  align-items:center;
}
.badge {
  padding:3px 8px;border-radius:20px;font-size:10px;
  background:var(--badge);color:var(--muted);
}
.toggle-theme {
  cursor:pointer;
  font-size:13px;
  padding:4px 8px;
  border-radius:50%;
  background:var(--badge);
  display:flex;
  align-items:center;
  justify-content:center;
}
.grid {
  display:grid;grid-template-columns:1fr 1fr;gap:10px;
}

/* ===== TAB ACTIVE STATE (PREMIUM â€“ BLUE PILL) ===== */
.tab-active {
  color:white !important;
}

.tab-inactive {
  color:var(--text) !important;
  opacity:0.6;
}


/* ===== TIME RANGE BUTTON STYLE ===== */
.time-btn {
  padding:6px 12px;
  font-size:11px;
  font-weight:600;
  border-radius:20px;
  background:#5a67ff22;
  color:var(--text);
  cursor:pointer;
  transition: all 0.2s ease;
  user-select:none;
}

.time-btn:hover {
  background:#5a67ff33;
}

.time-btn.active {
  background:#5a67ff;
  color:white;
  box-shadow:0 2px 6px rgba(90,103,255,0.4);
}


/* ===== 3D SENSOR BOXES ===== */
.sensor {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  position: relative;
  box-shadow:
    0 4px 10px rgba(0,0,0,0.08),
    0 1px 3px rgba(0,0,0,0.06);
  transition: transform .15s ease, box-shadow .15s ease;
}
.sensor:hover {
  transform: translateY(-2px);
  box-shadow:
    0 10px 18px rgba(0,0,0,0.12),
    0 4px 6px rgba(0,0,0,0.08);
}
.dark .sensor {
  box-shadow:
    0 4px 10px rgba(0,0,0,0.5),
    0 1px 3px rgba(0,0,0,0.4);
}
.sensor::after {
  content:"";
  position:absolute;
  inset:0;
  border-radius:14px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.15);
  pointer-events:none;
}
.sensor .icon {
  position:absolute;
  top:10px;
  right:10px;
  opacity:.5;
}

.sensor h5 {font-size:10px;opacity:.6;margin:0 0 6px 0;}
.value {font-size:22px;font-weight:700;}
.unit {font-size:11px;opacity:.6;}

/* ===== CONTROL BOXES ===== */
.control-box {
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  position: relative;
  box-shadow:
    0 4px 10px rgba(0,0,0,0.08),
    0 1px 3px rgba(0,0,0,0.06);
  transition: transform .15s ease, box-shadow .15s ease;
  margin-bottom:10px;
}
.control-box:hover {
  transform: translateY(-2px);
  box-shadow:
    0 10px 18px rgba(0,0,0,0.12),
    0 4px 6px rgba(0,0,0,0.08);
}
.dark .control-box {
  box-shadow:
    0 4px 10px rgba(0,0,0,0.5),
    0 1px 3px rgba(0,0,0,0.4);
}
.control-title {
  font-size:11px;
  opacity:.6;
  text-align:center;
  margin-bottom:6px;
}
.control-value {
  font-size:22px;
  font-weight:700;
  text-align:center;
}

/* Extra spacing before mode box */
.control-box.mode-box {
  margin-top:16px;
}

.ctrl-grid {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ctrl-btn {
  background:#5a67ff22;
  border-radius:14px;
  padding:16px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
}
.motor-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#5a67ff11;
  padding:10px;
  border-radius:12px;
  margin-top:8px;
}
.status-pill {
  padding:4px 10px;
  border-radius:12px;
  font-size:11px;
  font-weight:600;
}
.off {background:#64748b33;color:var(--muted);}
.on {background:#22c55e33;color:#22c55e;}
.master-toggle {
  width:42px;height:22px;background:#64748b66;
  border-radius:11px;position:relative;cursor:pointer;
}
.master-toggle::after {
  content:"";width:18px;height:18px;background:white;
  border-radius:50%;position:absolute;top:2px;left:2px;
  transition:.2s;
}
.master-toggle.active {background:#5a67ff;}
.master-toggle.active::after {left:22px;}
.locked-icon {
  font-size:18px;
  color:#f59e0b;
}

.footer {
  bottom: 5px;
  left: 50%;
  opacity: 0.7;
  text-align: center;
}

/* ===== DoseSense Branding ===== */
.dosesense-brand{
  display:flex;
  align-items:center;
  gap:8px;
}
.dosesense-brand .logo-box{
  width:26px;
  height:26px;
  background:#5a67ff;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.dosesense-brand .logo-box svg{
  width:14px;
  height:14px;
  fill:white;
}
.dosesense-brand .brand-name{
  font-family:"Debussy",sans-serif;
  font-size:18px;
  font-weight:normal;
  color:var(--text);
}

/* ===== ORIENTATION ICON ===== */
.orientation-icon {
  width:16px;
  height:16px;
  opacity:0.85;
}
.dark .orientation-icon {
  filter: invert(1);
}

/* ===== FORCE LANDSCAPE LAYOUT BY ROLE (ORDER SAFE) ===== */
body.landscape .app {
  max-width: 100%;
  display: grid;
  grid-template-columns: 1.1fr 0.9fr;
  grid-template-areas:
    "header header"
    "sensors controls"
    "sensors actuators";
  gap: 12px;
}

/* HEADER */
body.landscape .header {
  grid-area: header;
}

/* SENSOR CARD: identified by presence of .sensor elements */
body.landscape .card:has(.sensor) {
  grid-auto-rows: minmax(140px, auto);
  grid-area: sensors;
  align-self: start;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* Make each sensor tile bigger */
body.landscape .sensor {
  min-height: clamp(256px, 18vh, 180px);
}

/* ACTUATORS: identified by motor rows â†’ now BOTTOM RIGHT */
body.landscape .card:has(.motor-row) {
  grid-area: actuators;
  align-self: start;
}

/* CONTROLS: identified by EC SETPOINT â†’ now TOP RIGHT */
body.landscape .card:has(#ecSet) {
  grid-area: controls;
  align-self: start;
}


/* ===== ENLARGE SENSOR VALUES IN LANDSCAPE ===== */
body.landscape .sensor .value {
  font-size: clamp(35px, 4vw, 60px);
  line-height: 1.1;
}

body.landscape .sensor .unit {
  font-size: 15px;
}

body.landscape .sensor h5 {
  font-size: 20px;
  letter-spacing: 0.5px;
}

</style>
</head>

<body>

<div class="app">

<div class="header">
  <div class="brand dosesense-brand">
    <div class="logo-box">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C12 2 5 10.3 5 14.5C5 18.1 8.1 21 12 21C15.9 21 19 18.1 19 14.5C19 10.3 12 2 12 2ZM12 19C9.8 19 8 17.2 8 15C8 13.3 10.3 9.9 12 7.6C13.7 9.9 16 13.3 16 15C16 17.2 14.2 19 12 19Z"/>
      </svg>
    </div>
    <span class="brand-name">DoseSense</span>
  </div>

  <div class="status">
    <span class="badge" id="connStatus">OFFLINE</span>
    <span class="badge" id="deviceIdBadge">ID:----</span>
    <span class="toggle-theme" onclick="toggleTheme()" id="themeBtn">ðŸŒ™</span>
    <span class="toggle-theme" onclick="toggleOrientation()" title="Rotate View">
      <img src="icons/orientation.png" class="orientation-icon">
    </span>
  </div>
</div>

<!-- ===== TAB SELECTOR =====
<div class="card" style="display:flex;gap:10px;justify-content:center;">
  <div class="ctrl-btn" onclick="showDashboard()">Dashboard</div>
  <div class="ctrl-btn" onclick="showGraphs()">Graphs</div>
</div> -->

<!-- ================= TAB SELECTOR (PREMIUM SEGMENTED CONTROL) ================= -->
<div class="card" style="
  position:relative;
  display:flex;
  padding:4px;
  gap:0;
  overflow:hidden;
">

  <!-- Sliding Pill -->
<div id="tabPill" style="
  position:absolute;
  top:4px;
  left:4px;
  width:calc(50% - 4px);
  height:calc(100% - 8px);
  background:#5a67ff;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
  transition: left 0.3s ease;
  z-index:0;
"></div>


  <!-- Dashboard Tab -->
  <div id="tabDashboard" onclick="showDashboard()" style="
    flex:1;
    text-align:center;
    padding:8px 0;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    z-index:1;
  ">
    Dashboard
  </div>

  <!-- Graphs Tab -->
  <div id="tabGraphs" onclick="showGraphs()" style="
    flex:1;
    text-align:center;
    padding:8px 0;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    z-index:1;
  ">
    Graphs
  </div>

</div>







<!-- ===== DASHBOARD VIEW START ===== -->
<div id="dashboardView">


<div class="card grid">
  <div class="sensor"><span class="icon">ðŸŒ¡</span><h5>TEMPERATURE</h5><div class="value" id="tempVal">--</div><span class="unit">Â°C</span></div>
  <div class="sensor"><span class="icon">ðŸ’§</span><h5>HUMIDITY</h5><div class="value" id="humVal">--</div><span class="unit">%</span></div>
  <div class="sensor"><span class="icon">ðŸ§ª</span><h5>WATER pH</h5><div class="value" id="phVal">--</div><span class="unit">pH</span></div>
  <div class="sensor"><span class="icon">âš¡</span><h5>WATER EC</h5><div class="value" id="ecVal">--</div><span class="unit">ÂµS/cm</span></div>
</div>


<div class="card">
  <div class="control-box">
    <div class="control-title">EC SETPOINT</div>
    <div class="control-value" id="ecSet">0</div>
    <span class="unit" style="display:block;text-align:center">ÂµS/cm</span>
  </div>
  <div class="ctrl-grid" style="margin-top:10px;">
    <div class="ctrl-btn" onclick="sendCmd('ec_down')">- EC DOWN</div>
    <div class="ctrl-btn" onclick="sendCmd('ec_up')">+ EC UP</div>
  </div>
  <div class="control-box mode-box">
    <div class="control-title">CURRENT MODE</div>
    <div class="control-value" id="modeVal">--</div>
  </div>
  <div class="ctrl-grid">
    <div class="ctrl-btn" onclick="sendCmd('auto')">AUTO</div>
    <div class="ctrl-btn" onclick="sendCmd('manual')">MANUAL</div>
  </div>
</div>

<div class="card">
  <h5>SYSTEM ACTUATORS</h5>
  <div class="motor-row">Motor A <span id="motorAStatus" class="status-pill off">OFF</span></div>
  <div class="motor-row">Motor B <span id="motorBStatus" class="status-pill off">OFF</span></div>
  <div class="motor-row">
    Master 
    <span id="masterControlArea">
      <div class="master-toggle" id="masterToggle" onclick="toggleMaster()"></div>
    </span>
  </div>
</div>

</div> <!-- end dashboardView -->

<!-- ===== GRAPH VIEW START (HIDDEN) ===== -->
<div id="graphView" style="display:none;">


<!-- ===== SENSOR GRAPHS (VERTICAL SENSOR-STYLE BOXES) ===== -->
<div class="card">
  <h5>SENSOR GRAPHS</h5>

  <!-- Time Range Buttons -->
<!-- ===== TIME RANGE SELECTOR (STYLISH) ===== -->
<div id="timeBar" style="
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:14px;
">

  <div class="time-btn" id="t-live" onclick="setTime('live')">Live</div>
  <div class="time-btn" id="t-1m" onclick="setTime('1m')">1 Min</div>
  <div class="time-btn" id="t-10m" onclick="setTime('10m')">10 Min</div>
  <div class="time-btn" id="t-30m" onclick="setTime('30m')">30 Min</div>
  <div class="time-btn" id="t-1h" onclick="setTime('1h')">1 Hr</div>
  <div class="time-btn" id="t-6h" onclick="setTime('6h')">6 Hr</div>
  <div class="time-btn" id="t-24h" onclick="setTime('24h')">24 Hr</div>

</div>


  <!-- Vertical Stack -->
  <div style="display:flex;flex-direction:column;gap:12px;">

    <!-- Temperature Graph -->
    <div class="sensor">
      <span class="icon">ðŸŒ¡</span>
      <h5>TEMPERATURE (Â°C)</h5>
      <canvas id="tempChart" height="140"></canvas>
    </div>

    <!-- Humidity Graph -->
    <div class="sensor">
      <span class="icon">ðŸ’§</span>
      <h5>HUMIDITY (%)</h5>
      <canvas id="humChart" height="140"></canvas>
    </div>

    <!-- pH Graph -->
    <div class="sensor">
      <span class="icon">ðŸ§ª</span>
      <h5>WATER pH</h5>
      <canvas id="phChart" height="140"></canvas>
    </div>

    <!-- EC Graph -->
    <div class="sensor">
      <span class="icon">âš¡</span>
      <h5>WATER EC (ÂµS/cm)</h5>
      <canvas id="ecChart" height="140"></canvas>
    </div>

  </div>
</div>
<!-- ===== END SENSOR GRAPHS ===== -->
</div> <!-- end graphView -->


<div class="footer">DoseSense Â© Veltrix Robotic 2026 | v1.0.0</div>

</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const DEVICE_MAC = urlParams.get("device");

if(!DEVICE_MAC){
  alert("No Device ID provided");
  window.location.href="login.html";
}

const broker="wss://broker.emqx.io:8084/mqtt";
const topicData="dosesense/"+DEVICE_MAC+"/data";
const topicCmd ="dosesense/"+DEVICE_MAC+"/cmd";
const client=mqtt.connect(broker,{reconnectPeriod:3000});

let lastDataTime=0;
const DATA_TIMEOUT=10000;

setOffline();
loadTheme();
loadViewMode();

client.on("connect",()=>client.subscribe(topicData));

client.on("message",(topic,message)=>{
  const p=message.toString().trim().split(",");
  if(p.length>=9){
    lastDataTime=Date.now();
    setOnline();
    deviceIdBadge.innerText="ID:"+p[0];
    tempVal.innerText=parseFloat(p[1]).toFixed(1);
    humVal.innerText=parseFloat(p[2]).toFixed(1);
    phVal.innerText=parseFloat(p[3]).toFixed(2);
    ecVal.innerText=parseFloat(p[4]).toFixed(0);
    ecSet.innerText=parseFloat(p[5]).toFixed(0);
    updateMotorStatus("motorAStatus",p[6]);
    updateMotorStatus("motorBStatus",p[7]);
    modeVal.innerText=p[8];
    updateMasterUI(p[8]);
    syncMasterToggle(p[6],p[7]);
  }
});

function updateMasterUI(mode){
  const area=document.getElementById("masterControlArea");
  if(mode==="AUTO"){
    area.innerHTML='<span class="locked-icon">ðŸ”’</span>';
  } else {
    area.innerHTML='<div class="master-toggle" id="masterToggle" onclick="toggleMaster()"></div>';
  }
}

setInterval(()=>{
  if(Date.now()-lastDataTime>DATA_TIMEOUT) setOffline();
},1000);

function setOnline(){
  connStatus.innerText="ONLINE";
  connStatus.style.color="#22c55e";
}
function setOffline(){
  connStatus.innerText="OFFLINE";
  connStatus.style.color="#ef4444";
}

function sendCmd(cmd){client.publish(topicCmd,cmd);}
function updateMotorStatus(id,state){
  const el=document.getElementById(id);
  el.innerText=state==="ON"?"ACTIVE":"OFF";
  el.className="status-pill "+(state==="ON"?"on":"off");
}
function toggleMaster(){
  const el=document.getElementById("masterToggle");
  el.classList.toggle("active");
  client.publish(topicCmd,"master:"+(el.classList.contains("active")?"ON":"OFF"));
}
function syncMasterToggle(a,b){
  const el=document.getElementById("masterToggle");
  if(!el) return;
  (a==="ON"&&b==="ON")?el.classList.add("active"):el.classList.remove("active");
}

function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
  updateThemeIcon();
}
function loadTheme(){
  if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
  }
  updateThemeIcon();
}
function updateThemeIcon(){
  themeBtn.innerText=document.body.classList.contains("dark")?"â˜€ï¸":"ðŸŒ™";
}

/* ===== ORIENTATION TOGGLE ===== */
function toggleOrientation(){
  document.body.classList.toggle("landscape");
  const isLandscape=document.body.classList.contains("landscape");
  localStorage.setItem("viewMode",isLandscape?"landscape":"portrait");
}
function loadViewMode(){
  if(localStorage.getItem("viewMode")==="landscape"){
    document.body.classList.add("landscape");
  }
}
/* ===== GRAPH SYSTEM (NON-INTRUSIVE ADD-ON) ===== */

let rangeMode = "live";

const buffers = {
  temp: [],
  hum: [],
  ph: [],
  ec: []
};

function maxPoints() {
  switch(rangeMode){
    case "1m":  return 60;
    case "10m": return 600;
    case "30m": return 1800;
    case "1h":  return 3600;
    case "6h":  return 21600;
    case "24h": return 86400;
    default:    return 120;   // live (last ~2 minutes fast view)
  }
}

function pushData(buf, value){
  buf.push({ t: Date.now(), v: value });
  if(buf.length > maxPoints()) buf.shift();
}

function setTime(r){
  rangeMode = r;

  // remove active from all
  document.querySelectorAll(".time-btn").forEach(b=>{
    b.classList.remove("active");
  });

  // activate selected
  const id = "t-" + r;
  const btn = document.getElementById(id);
  if(btn) btn.classList.add("active");
}


/* ----- Create Charts ----- */
function makeChart(ctx, label){
  return new Chart(ctx,{
    type:"line",
    data:{ labels:[], datasets:[{ label, data:[], tension:0.25 }] },
    options:{
      responsive:true,
      animation:false,
      plugins:{ legend:{display:false}},
      scales:{ x:{display:false} }
    }
  });
}

const tempChart = makeChart(document.getElementById("tempChart"),"Temp");
const humChart  = makeChart(document.getElementById("humChart"),"Hum");
const phChart   = makeChart(document.getElementById("phChart"),"pH");
const ecChart   = makeChart(document.getElementById("ecChart"),"EC");

/* ----- Update Charts Periodically ----- */
setInterval(()=>{
  updateChart(tempChart,buffers.temp);
  updateChart(humChart,buffers.hum);
  updateChart(phChart,buffers.ph);
  updateChart(ecChart,buffers.ec);
},1000);

function updateChart(chart, buf){
  chart.data.labels = buf.map(x=>"");
  chart.data.datasets[0].data = buf.map(x=>x.v);
  chart.update();
}

/* ----- Hook into existing MQTT data flow (NO CHANGE TO YOUR CODE) ----- */
const oldHandler = client._events.message;

client.on("message",(topic,message)=>{
  const p = message.toString().trim().split(",");
  if(p.length>=9){
    pushData(buffers.temp, parseFloat(p[1]));
    pushData(buffers.hum,  parseFloat(p[2]));
    pushData(buffers.ph,   parseFloat(p[3]));
    pushData(buffers.ec,   parseFloat(p[4]));
  }
});

/* ===== TAB SWITCH (DASHBOARD / GRAPHS) ===== */
function showDashboard(){
  document.getElementById("dashboardView").style.display = "block";
  document.getElementById("graphView").style.display = "none";

  // move pill to left
  document.getElementById("tabPill").style.left = "4px";

  // highlight text
  tabDashboard.classList.add("tab-active");
  tabDashboard.classList.remove("tab-inactive");

  tabGraphs.classList.add("tab-inactive");
  tabGraphs.classList.remove("tab-active");
}

function showGraphs(){
  document.getElementById("dashboardView").style.display = "none";
  document.getElementById("graphView").style.display = "block";

  // move pill to right
  document.getElementById("tabPill").style.left = "calc(50% + 0px)";

  // highlight text
  tabGraphs.classList.add("tab-active");
  tabGraphs.classList.remove("tab-inactive");

  tabDashboard.classList.add("tab-inactive");
  tabDashboard.classList.remove("tab-active");
}



// Default active tab = Dashboard
showDashboard();
// Default active time = Live
setTime("live");

</script>

</body>
</html>
