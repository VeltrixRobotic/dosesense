<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MQTT Dashboard (Thresholds Fixed)</title>

<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --bg:#f2f5f9; --card:#fff; --text:#000; --accent:#007bff; }
body.dark { --bg:#121212; --card:#1e1e1e; --text:#f0f0f0; --accent:#4dabf7; }
body {
  background:var(--bg); color:var(--text);
  font-family:Arial; padding:20px;
}
h1{text-align:center}
button{padding:8px 12px;border:none;border-radius:6px;background:var(--accent);color:white;cursor:pointer}
.topbar{display:flex;justify-content:space-between;max-width:900px;margin:auto;margin-bottom:15px}
.cards{display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
.card{background:var(--card);padding:15px;width:200px;border-radius:10px;text-align:center;box-shadow:0 0 10px rgba(0,0,0,.15)}
.value{font-size:32px;font-weight:bold;color:var(--accent)}
.alert{color:red !important}
.status{text-align:center;font-weight:bold;margin:10px}
.connected{color:limegreen}.disconnected{color:red}
.charts{max-width:900px;margin:auto}
canvas{background:var(--card);padding:10px;border-radius:10px;margin-bottom:20px}
.footer{text-align:center;font-size:12px;opacity:.7}
.threshold-panel{max-width:900px;margin:20px auto;background:var(--card);padding:15px;border-radius:10px}
.threshold-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;align-items:center}
.threshold-grid input{padding:5px;width:100%}
</style>
</head>

<body>

<h1>MQTT Dashboard with Thresholds</h1>

<div class="topbar">
  <button onclick="toggleDarkMode()">ðŸŒ™ Dark Mode</button>
  <button onclick="exportCSV()">ðŸ’¾ Export CSV</button>
</div>

<div id="status" class="status disconnected">Connecting...</div>

<div class="cards">
  <div class="card"><h3>Temperature</h3><div id="tempVal" class="value">--</div>Â°C</div>
  <div class="card"><h3>Humidity</h3><div id="humVal" class="value">--</div>%</div>
  <div class="card"><h3>pH</h3><div id="phVal" class="value">--</div>pH</div>
</div>

<div class="threshold-panel">
<h3>Threshold Settings</h3>
<div class="threshold-grid">
  <b>Parameter</b><b>Min</b><b>Max</b><b>Apply</b>

  Temp (Â°C)
  <input id="tmin" type="number" value="10">
  <input id="tmax" type="number" value="35">
  <button onclick="setThresholds()">âœ”</button>

  Hum (%)
  <input id="hmin" type="number" value="30">
  <input id="hmax" type="number" value="80">
  <button onclick="setThresholds()">âœ”</button>

  pH
  <input id="pmin" type="number" value="5.5">
  <input id="pmax" type="number" value="7.5">
  <button onclick="setThresholds()">âœ”</button>
</div>
</div>

<div class="charts">
  <canvas id="tempChart"></canvas>
  <canvas id="humChart"></canvas>
  <canvas id="phChart"></canvas>
</div>

<div class="footer">Last update: <span id="lastUpdate">--</span></div>

<script>
const brokerUrl = "wss://broker.emqx.io:8084/mqtt";
const topic = "data";
const maxPoints = 30;
const csvData = [["Time","Temperature","Humidity","pH"]];

let thresholds = { tmin:10,tmax:35,hmin:30,hmax:80,pmin:5.5,pmax:7.5 };

function setThresholds() {
  thresholds.tmin = parseFloat(tmin.value);
  thresholds.tmax = parseFloat(tmax.value);
  thresholds.hmin = parseFloat(hmin.value);
  thresholds.hmax = parseFloat(hmax.value);
  thresholds.pmin = parseFloat(pmin.value);
  thresholds.pmax = parseFloat(pmax.value);
}

const statusEl = document.getElementById("status");
const tempEl = document.getElementById("tempVal");
const humEl = document.getElementById("humVal");
const phEl = document.getElementById("phVal");

const client = mqtt.connect(brokerUrl,{reconnectPeriod:3000});

client.on("connect",()=>{
  statusEl.textContent="Connected";
  statusEl.className="status connected";
  client.subscribe(topic);
});
client.on("offline",()=>{
  statusEl.textContent="Disconnected";
  statusEl.className="status disconnected";
});

function createChart(ctx,label){
  return new Chart(ctx,{
    type:'line',
    data:{labels:[],datasets:[{label:label,data:[],borderWidth:2,tension:0.2}]},
    options:{animation:false,responsive:true,scales:{x:{display:false}}}
  });
}

const tempChart=createChart(tempChartCanvas=document.getElementById("tempChart"),"Temperature");
const humChart=createChart(document.getElementById("humChart"),"Humidity");
const phChart=createChart(document.getElementById("phChart"),"pH");

function updateChart(chart,val){
  if(chart.data.datasets[0].data.length>=maxPoints){
    chart.data.datasets[0].data.shift();
    chart.data.labels.shift();
  }
  chart.data.datasets[0].data.push(val);
  chart.data.labels.push('');
  chart.update();
}

function toggleDarkMode(){document.body.classList.toggle("dark");}

function exportCSV(){
  const blob=new Blob([csvData.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="sensor_data.csv";
  a.click();
}

function applyAlert(el,val,min,max){
  if(val<min||val>max) el.classList.add("alert");
  else el.classList.remove("alert");
}

client.on("message",(topic,message)=>{
  const parts=message.toString().trim().split(",");
  if(parts.length>=3){
    const t=parseFloat(parts[0]);
    const h=parseFloat(parts[1]);
    const p=parseFloat(parts[2]);
    const time=new Date().toLocaleTimeString();

    tempEl.innerText=t.toFixed(1);
    humEl.innerText=h.toFixed(1);
    phEl.innerText=p.toFixed(2);
    lastUpdate.innerText=time;

    applyAlert(tempEl,t,thresholds.tmin,thresholds.tmax);
    applyAlert(humEl,h,thresholds.hmin,thresholds.hmax);
    applyAlert(phEl,p,thresholds.pmin,thresholds.pmax);

    updateChart(tempChart,t);
    updateChart(humChart,h);
    updateChart(phChart,p);

    csvData.push([time,t,h,p]);
  }
});
</script>

</body>
</html>

