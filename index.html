<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DoseSense Login</title>
<script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
@font-face {
  font-family: "Debussy";
  src: url("fonts/debussy.ttf") format("truetype");
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#ffffff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.login-box{
  width:360px;
  text-align:center;
}

h2{
  font-size:24px;
  font-weight:700;
  margin:0 0 18px;
  color:#1f2937;
  position:relative;
  bottom:5px;
  left:-100px;
}

.brand{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:18px;
  position:relative;
  top:-20px;
  left:-2.5px;
}

.logo-box{
  width:68px;
  height:68px;
  background:#5b6cff;
  border-radius:18px;
  display:flex;
  justify-content:center;
  align-items:center;
}

.logo-box svg{
  width:32px;
  height:32px;
  fill:white;
}

.brand-name{
  font-family:"Debussy",sans-serif;
  font-size:50px;
  font-weight:normal;
  color:#000;
}

.label{
  text-align:left;
  font-size:11px;
  color:#9ca3af;
  margin-bottom:6px;
}

input{
  width:100%;
  height:50px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  font-size:14px;
  margin-bottom:18px;
  box-sizing:border-box;
}

button{
  width:100%;
  height:52px;
  border-radius:10px;
  border:none;
  background:#3b82f6;
  color:white;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}

button:disabled{
  background:#aac2ff;
}

.status{
  margin-top:10px;
  font-size:13px;
}

.footer{
  margin-top:22px;
  font-size:10px;
  color:#9ca3af;
}
</style>
</head>

<body>

<div class="login-box">

  <!-- WELCOME BACK -->
  <h2>Welcome back</h2>

  <!-- BRAND -->
  <div class="brand">
    <div class="logo-box">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C12 2 5 10.3 5 14.5C5 18.1 8.1 21 12 21C15.9 21 19 18.1 19 14.5C19 10.3 12 2 12 2ZM12 19C9.8 19 8 17.2 8 15C8 13.3 10.3 9.9 12 7.6C13.7 9.9 16 13.3 16 15C16 17.2 14.2 19 12 19Z"/>
      </svg>
    </div>
    <div class="brand-name">DoseSense</div>
  </div>

  <!-- FORM -->
  <div class="label">ENTER DEVICE ID</div>
  <input type="text" id="deviceInput" placeholder="Device ID">
  <button id="loginBtn" onclick="verifyDevice()">Log In</button>

  <!-- STATUS -->
  <div class="status" id="statusMsg"></div>

  <!-- FOOTER -->
  <div class="footer">DoseSense Â© Veltrix Robotic 2026 | v1.0.0</div>

</div>

<script>
const broker="wss://broker.emqx.io:8084/mqtt";
const client = mqtt.connect(broker,{reconnectPeriod:3000});

let verified=false;
let checkTimer;
let isChecking=false;

client.on("message",(topic,message)=>{
  if(!isChecking) return;
  const payload = message.toString().trim().split(",");
  const mac = payload[0];
  const input = deviceInput.value.trim().toLowerCase();

  if(mac === input){
    verified=true;
    isChecking=false;
    client.unsubscribe("dosesense/+/data");
    statusMsg.style.color="green";
    statusMsg.innerText="Device online. Redirecting...";
    setTimeout(()=>{
      window.location.href="dosesense.html?device="+mac;
    },1000);
  }
});

function verifyDevice(){
  const input = deviceInput.value.trim().toLowerCase();
  if(!input){
    statusMsg.style.color="red";
    statusMsg.innerText="Please enter Device ID";
    return;
  }
  if(isChecking) return;

  verified=false;
  isChecking=true;
  loginBtn.disabled=true;
  statusMsg.style.color="#555";
  statusMsg.innerText="Checking device online...";

  client.subscribe("dosesense/+/data");

  clearTimeout(checkTimer);
  checkTimer=setTimeout(()=>{
    if(!verified){
      isChecking=false;
      loginBtn.disabled=false;
      client.unsubscribe("dosesense/+/data");
      statusMsg.style.color="red";
      statusMsg.innerText="ID INVALID or DEVICE OFFLINE";
    }
  },6000);
}
</script>

</body>
</html>
